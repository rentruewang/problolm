name: AI Code Detection Check

on: [push, pull_request]

jobs:
  ai-detect:
    name: ðŸ¤– Ai detection
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Get pip cache dir
        id: pip-cache
        run: |
          echo "dir=$(pip cache dir)" >> $GITHUB_OUTPUT

      - name: Cache pip packages
        uses: actions/cache@v3
        with:
          path: ${{ steps.pip-cache.outputs.dir }}
          key: ${{ runner.os }}-pip-torch-transformers-v2
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Cache Hugging Face models
        uses: actions/cache@v3
        with:
          path: ~/.cache/huggingface/hub
          key: ${{ runner.os }}-huggingface-gpt2-v2
          restore-keys: |
            ${{ runner.os }}-huggingface-

      - name: Install dependencies
        run: |
          pip install torch transformers

      - name: Get changed files
        id: files
        run: |
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            # For PRs, compare against the base branch
            files=$(git diff --name-only origin/${{ github.base_ref }}...HEAD | grep '\.py$$' || true)
          else
            # For push events
            if [ "${{ github.event.before }}" == "0000000000000000000000000000000000000000" ]; then
              # First commit - check all Python files in the commit
              files=$(git diff-tree --no-commit-id --name-only -r ${{ github.sha }} | grep '\.py$$' || true)
            else
              # Regular push - compare with previous commit
              files=$(git diff --name-only ${{ github.event.before }} ${{ github.sha }} | grep '\.py$$' || true)
            fi
          fi
          # Save files as multi-line string to handle spaces in filenames
          echo "changed_files<<EOF" >> $GITHUB_ENV
          echo "$files" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      - name: Run Detection Script
        env:
          AI_DETECT_MODELS: gpt2,distilgpt2,EleutherAI/gpt-neo-125M
          AI_DETECT_STRATEGY: min
          AI_DETECT_THRESHOLD: "12.0"
        run: |
          if [ -n "$changed_files" ]; then
            echo "Checking files for AI-generated code..."
            echo "$changed_files" | xargs -r python detect_ai.py
          else
            echo "No Python files changed."
          fi
